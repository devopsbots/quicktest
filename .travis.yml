language: generic
sudo: required

services:
  - docker
env:
  global:
    SHA=$(git rev-parse HEAD)
    
before_script:
   - curl -sS -o aws-iam-authenticator https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/linux/amd64/aws-iam-authenticator
   - curl -sS -o kubectl https://amazon-eks.s3-us-west-2.amazonaws.com/1.14.6/2019-08-22/bin/linux/amd64/kubectl
   - chmod +x ./kubectl ./aws-iam-authenticator
   - export PATH=$PWD/:$PATH
   - apt-get update && apt-get -y install jq python3-pip python3-dev && pip3 install --upgrade awscli
   - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

script:
  - docker run -e CI=true jzhao5/react-test npm run test

deploy:
  provider: script
  script: bash ./deploy.sh
  on:
    branch: master
  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY
  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_KEY